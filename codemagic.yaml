workflows:
  simulator-workflow:
    name: Build for iOS Simulator
    max_build_duration: 30
    instance_type: mac_mini_m1
    environment:
      vars:
        XCODE_PROJECT: "MonobankClone.xcodeproj"
        XCODE_SCHEME: "MonobankClone"
      xcode: latest
    scripts:
      - name: Build with Generic Destination for Simulator
        script: |
          set -e
          set -x
          
          cd MonobankClone
          
          # –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏
          xcodebuild clean -project "$XCODE_PROJECT" -scheme "$XCODE_SCHEME"
          
          # –°–æ–±–∏—Ä–∞–µ–º –¥–ª—è —Å–∏–º—É–ª—è—Ç–æ—Ä–∞
          xcodebuild build \
            -project "$XCODE_PROJECT" \
            -scheme "$XCODE_SCHEME" \
            -sdk iphonesimulator \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.5' \
            IPHONEOS_DEPLOYMENT_TARGET=15.0
            
      - name: Find and copy .app bundle
        script: |
          set -e
          
          # –ù–∞—Ö–æ–¥–∏–º .app —Ñ–∞–π–ª
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "MonobankClone.app" -type d | head -1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå .app bundle not found!"
            exit 1
          fi
          
          echo "‚úÖ Found .app at: $APP_PATH"
          
          # –ö–æ–ø–∏—Ä—É–µ–º –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
          mkdir -p "$CM_BUILD_DIR/simulator_build"
          cp -r "$APP_PATH" "$CM_BUILD_DIR/simulator_build/"
          
          echo "üì± App bundle copied for simulator use"
          ls -la "$CM_BUILD_DIR/simulator_build/"
    
    artifacts:
      - simulator_build/*.app
      - /Users/builder/Library/Developer/Xcode/DerivedData/**/*.app
    
    publishing:
      email:
        recipients:
          - nutipovottakvot@gmail.com
        notify:
          success: true
          failure: true

  ipa-workflow:
    name: Build IPA for Device
    max_build_duration: 45
    instance_type: mac_mini_m1
    environment:
      vars:
        XCODE_PROJECT: "MonobankClone.xcodeproj"
        XCODE_SCHEME: "MonobankClone"
        BUNDLE_ID: "com.nutipov.monobankclone"
      xcode: latest
    scripts:
      - name: Build unsigned IPA
        script: |
          set -e
          set -x
          
          cd MonobankClone
          
          # –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏
          xcodebuild clean -project "$XCODE_PROJECT" -scheme "$XCODE_SCHEME"
          
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏
          xcodebuild archive \
            -project "$XCODE_PROJECT" \
            -scheme "$XCODE_SCHEME" \
            -archivePath "$CM_BUILD_DIR/MonobankClone.xcarchive" \
            -destination 'generic/platform=iOS' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE="" \
            IPHONEOS_DEPLOYMENT_TARGET=15.0
      
      - name: Create IPA
        script: |
          set -e
          set -x
          
          cd "$CM_BUILD_DIR"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∞—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–ª—Å—è
          if [ ! -d "MonobankClone.xcarchive" ]; then
            echo "‚ùå Archive not found!"
            ls -la
            exit 1
          fi
          
          echo "‚úÖ Archive found, checking contents..."
          ls -la MonobankClone.xcarchive/Products/Applications/
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ .app —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ ! -d "MonobankClone.xcarchive/Products/Applications/MonobankClone.app" ]; then
            echo "‚ùå App bundle not found!"
            exit 1
          fi
          
          # –°–æ–∑–¥–∞–µ–º IPA
          mkdir -p ipa
          mkdir -p Payload
          
          # –ö–æ–ø–∏—Ä—É–µ–º .app –≤ Payload
          cp -r MonobankClone.xcarchive/Products/Applications/MonobankClone.app Payload/
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
          if [ ! -d "Payload/MonobankClone.app" ]; then
            echo "‚ùå Failed to copy app to Payload!"
            exit 1
          fi
          
          echo "‚úÖ App copied to Payload, creating IPA..."
          
          # –°–æ–∑–¥–∞–µ–º IPA
          zip -r ipa/MonobankClone.ipa Payload
          
          # –û—á–∏—â–∞–µ–º
          rm -rf Payload
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ IPA —Å–æ–∑–¥–∞–ª—Å—è
          if [ ! -f "ipa/MonobankClone.ipa" ]; then
            echo "‚ùå Failed to create IPA!"
            exit 1
          fi
          
          echo "‚úÖ IPA created successfully:"
          ls -lh ipa/MonobankClone.ipa
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ IPA
          echo "üìã IPA contents:"
          unzip -l ipa/MonobankClone.ipa | head -10
          
      - name: Alternative IPA creation (if main fails)
        script: |
          set -e
          
          cd "$CM_BUILD_DIR"
          
          # –ï—Å–ª–∏ IPA —É–∂–µ —Å–æ–∑–¥–∞–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
          if [ -f "ipa/MonobankClone.ipa" ]; then
            echo "‚úÖ IPA already exists, skipping alternative method"
            exit 0
          fi
          
          echo "üîÑ Trying alternative IPA creation method..."
          
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ xcodebuild
          xcodebuild -exportArchive \
            -archivePath MonobankClone.xcarchive \
            -exportPath ipa \
            -exportOptionsPlist <(cat <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>development</string>
    <key>signingStyle</key>
    <string>manual</string>
    <key>stripSwiftSymbols</key>
    <false/>
</dict>
</plist>
EOF
) || echo "Alternative method failed, but that's okay"
    
    artifacts:
      - ipa/*.ipa
      - MonobankClone.xcarchive
    
    publishing:
      email:
        recipients:
          - nutipovottakvot@gmail.com
        notify:
          success: true
          failure: true

  ios-workflow:
    name: Monobank Clone - iOS Build for Sideloadly
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      vars:
        XCODE_PROJECT: "MonobankClone.xcodeproj"
        XCODE_SCHEME: "MonobankClone"
        BUNDLE_ID: "com.nutipov.monobankclone"
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: '*'
          include: true
    scripts:
      - name: Set up iOS 15+ deployment target
        script: |
          cd MonobankClone
          # –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ deployment target —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ iOS 15.0
          /usr/libexec/PlistBuddy -c "Set :objects:A1000000A:buildSettings:IPHONEOS_DEPLOYMENT_TARGET 15.0" MonobankClone.xcodeproj/project.pbxproj || echo "Deployment target already set"
          
      - name: Install CocoaPods dependencies
        script: |
          cd MonobankClone
          pod install --repo-update || echo "No Podfile found, skipping pod install"
          
      - name: Build unsigned archive for Sideloadly
        script: |
          set -e
          set -x
          
          # –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏
          xcodebuild clean -project "$XCODE_PROJECT" -scheme "$XCODE_SCHEME"
          
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏ (–¥–ª—è Sideloadly)
          xcodebuild archive \
            -project "$XCODE_PROJECT" \
            -scheme "$XCODE_SCHEME" \
            -archivePath "$CM_BUILD_DIR/MonobankClone.xcarchive" \
            -destination 'generic/platform=iOS' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE="" \
            IPHONEOS_DEPLOYMENT_TARGET=15.0 \
            ENABLE_BITCODE=NO
      
      - name: Create IPA for Sideloadly
        script: |
          set -e
          set -x
          
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è IPA
          mkdir -p "$CM_BUILD_DIR/ipa"
          cd "$CM_BUILD_DIR"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∞—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–ª—Å—è
          if [ ! -d "MonobankClone.xcarchive" ]; then
            echo "‚ùå Archive not found!"
            exit 1
          fi
          
          echo "‚úÖ Archive found, creating IPA..."
          
          # –°–æ–∑–¥–∞–µ–º Payload –ø–∞–ø–∫—É
          mkdir -p Payload
          
          # –ö–æ–ø–∏—Ä—É–µ–º .app –≤ Payload
          cp -r MonobankClone.xcarchive/Products/Applications/MonobankClone.app Payload/
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ .app —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª—Å—è
          if [ ! -d "Payload/MonobankClone.app" ]; then
            echo "‚ùå App bundle not found in Payload!"
            exit 1
          fi
          
          echo "‚úÖ App bundle copied to Payload"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ .app
          echo "üì± App bundle contents:"
          ls -la Payload/MonobankClone.app/
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º Assets
          echo "üé® Checking for Assets:"
          find Payload/MonobankClone.app -name "Assets.car" -o -name "AppIcon*" || echo "No assets found"
          
          # –°–æ–∑–¥–∞–µ–º IPA
          zip -r ipa/MonobankClone.ipa Payload
          
          # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          rm -rf Payload
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä IPA
          echo "üì¶ IPA created:"
          ls -lh ipa/MonobankClone.ipa
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ IPA
          echo "üìã IPA contents:"
          unzip -l ipa/MonobankClone.ipa | head -20
    
    artifacts:
      - ipa/*.ipa
      - MonobankClone.xcarchive
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      email:
        recipients:
          - nutipovottakvot@gmail.com
        notify:
          success: true
          failure: true